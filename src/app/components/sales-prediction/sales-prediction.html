<div class="prediction-container mat-elevation-z2">
  <div class="header-container">
    <div class="title-section">
      <h1 class="mat-headline-5">Sales Date Prediction</h1>
      <p class="subtitle">Predicting when customers are likely to place their next order</p>
    </div>
    
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search customers</mat-label>
      <input matInput [(ngModel)]="searchTerm" (input)="applyFilter($event)" placeholder="Search by customer name">
      <button *ngIf="searchTerm" matSuffix mat-icon-button aria-label="Clear" (click)="clearFilter()">
        <mat-icon>close</mat-icon>
      </button>
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>
  </div>

  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading predictions...</span>
  </div>
  
  <div *ngIf="error" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <span>Error loading predictions.</span>
    <button mat-raised-button color="primary" (click)="loadPredictions()">Retry</button>
  </div>

  <div class="table-container" *ngIf="!loading && !error">
    <mat-card class="empty-state" *ngIf="dataSource.data.length === 0">
      <mat-card-content>
        <mat-icon>info</mat-icon>
        <p>No predictions found. Try clearing your search filter.</p>
      </mat-card-content>
    </mat-card>

    <table mat-table [dataSource]="dataSource" matSort *ngIf="dataSource.data && dataSource.data.length > 0" 
           class="mat-elevation-z1 prediction-table">

      <!-- Customer Name Column -->
      <ng-container matColumnDef="customerName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="customer-column">Customer Name</th>
        <td mat-cell *matCellDef="let item" class="customer-column">{{ item.customerName }}</td>
      </ng-container>

      <!-- Last Order Date Column -->
      <ng-container matColumnDef="lastOrderDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="date-column">Last Order Date</th>
        <td mat-cell *matCellDef="let item" class="date-column">{{ formatDate(item.lastOrderDate) }}</td>
      </ng-container>
      
      <!-- Average Days Column -->
      <ng-container matColumnDef="averageDaysBetweenOrders">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="days-column">Avg. Days Between Orders</th>
        <td mat-cell *matCellDef="let item" class="days-column">{{ item.averageDaysBetweenOrders }} days</td>
      </ng-container>

      <!-- Next Predicted Order Column -->
      <ng-container matColumnDef="nextPredictedOrder">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="date-column">Next Predicted Order</th>
        <td mat-cell *matCellDef="let item" class="date-column">
          <span [ngClass]="'prediction-badge ' + getStatusClass(item.nextPredictedOrder)">
            {{ formatDate(item.nextPredictedOrder) }}
            <span class="days-indicator" [ngClass]="getStatusClass(item.nextPredictedOrder)">
              {{ daysUntilNextOrder(item.nextPredictedOrder) }} days 
              {{ daysUntilNextOrder(item.nextPredictedOrder) >= 0 ? 'from now' : 'overdue' }}
            </span>
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="actions-column">Actions</th>
        <td mat-cell *matCellDef="let item" class="action-buttons actions-column">
          <a mat-icon-button 
             color="primary" 
             [routerLink]="['/customers', item.customerId, 'orders']"
             matTooltip="View customer orders"
             matTooltipPosition="above"
             [matTooltipShowDelay]="300">
            <mat-icon>person</mat-icon>
          </a>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
      aria-label="Select page of predictions">
    </mat-paginator>
  </div>
</div>
